# Модуль "Закупки" (Procurement)

**Версия:** 1.0
**Дата:** 2025-11-28
**Соответствует:** DESIGN_SYSTEM.md v4.0

---

## Содержание

1. [Введение](#1-введение)
2. [Архитектура и участники](#2-архитектура-и-участники)
3. [Message Relay System](#3-message-relay-system)
4. [Структура данных](#4-структура-данных)
5. [UI экраны](#5-ui-экраны)
6. [Компоненты по DESIGN_SYSTEM](#6-компоненты-по-design_system)
7. [Мок-данные](#7-мок-данные)
8. [Интеграция с Chat модулем](#8-интеграция-с-chat-модулем)
9. [Структура файлов](#9-структура-файлов)

---

## 1. Введение

### 1.1 Назначение модуля

Модуль **"Закупки"** — это расширение Chat flow для управления заявками на поиск и закупку товаров из Китая. Модуль предназначен **только для менеджеров** в Platform Web.

### 1.2 Ключевая особенность

**Изоляция участников:** Партнёр-закупщик и клиент НЕ видят друг друга. Вся коммуникация происходит **через бота**, что обеспечивает:
- Защиту клиентской базы
- Контроль качества коммуникации
- Централизованное управление процессом

### 1.3 Глоссарий

| Термин | Описание |
|--------|----------|
| **SourcingRequest** | Заявка на поиск товара |
| **Message Relay** | Система проброса сообщений между темами через бота |
| **Topic** | Тема в Telegram группе (forum topic) |
| **Партнёр** | Закупщик в Китае, работает через Telegram |
| **Клиент** | Заказчик товара, работает через Telegram |
| **Менеджер** | Сотрудник WellWon, работает через Platform Web |

---

## 2. Архитектура и участники

### 2.1 Участники системы

| Участник | Интерфейс | Роль | Видимость |
|----------|-----------|------|-----------|
| **Менеджер** | Platform Web (раздел Закупки) | Управляет заявками, контролирует процесс | Видит ВСЁ |
| **Клиент** | Telegram (группа компании) | Заказчик товара | Видит сообщения "от бота" |
| **Партнёр** | Telegram (своя группа) | Ищет и закупает товар | Видит сообщения "от бота" |

### 2.2 Flow взаимодействия

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           FLOW СОЗДАНИЯ ЗАЯВКИ                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. TELEGRAM ГРУППА КЛИЕНТА (1 группа = 1 компания)                        │
│     └── Тема = Сделка клиента                                               │
│         └── Переписка до момента "нужен поиск товара"                       │
│                                                                             │
│  2. МЕНЕДЖЕР В PLATFORM WEB                                                 │
│     └── Нажимает "Создать заявку на поиск"                                  │
│         └── Заполняет форму (товар, требования, партнёр)                    │
│                                                                             │
│  3. СИСТЕМА СОЗДАЁТ                                                         │
│     ├── SourcingRequest в базе данных                                       │
│     ├── Новую тему в Telegram группе партнёра                              │
│     └── Отправляет условия заявки в тему партнёра                          │
│                                                                             │
│  4. MESSAGE RELAY АКТИВИРУЕТСЯ                                              │
│     ├── Сообщения из темы клиента → пересылаются в тему партнёра           │
│     ├── Сообщения из темы партнёра → пересылаются в тему клиента           │
│     └── Оба видят сообщения "от бота" (не друг от друга)                   │
│                                                                             │
│  5. МЕНЕДЖЕР КОНТРОЛИРУЕТ ПРОЦЕСС                                          │
│     ├── Видит всю переписку в Platform Web                                  │
│     ├── Меняет статусы заявки                                               │
│     └── Может вмешаться в любой момент                                      │
│                                                                             │
│  6. ЗАВЕРШЕНИЕ ЗАЯВКИ                                                       │
│     ├── Статус → "Завершена"                                                │
│     ├── Message Relay отключается                                           │
│     └── Партнёр получает уведомление об успехе                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 Диаграмма связей

```
┌────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   Telegram                    Platform Web                 Telegram        │
│                                                                             │
│  ┌─────────────┐           ┌──────────────┐           ┌─────────────┐      │
│  │   Клиент    │           │   Менеджер   │           │   Партнёр   │      │
│  │  (Группа)   │           │  (Закупки)   │           │  (Группа)   │      │
│  └──────┬──────┘           └──────┬───────┘           └──────┬──────┘      │
│         │                         │                          │              │
│         │     ┌───────────────────┴───────────────────┐     │              │
│         │     │                                       │     │              │
│         ▼     ▼                                       ▼     ▼              │
│     ┌─────────────────────────────────────────────────────────┐            │
│     │                     WellWon Bot                          │            │
│     │                                                          │            │
│     │  ┌─────────────────────────────────────────────────┐    │            │
│     │  │            MESSAGE RELAY SERVICE                 │    │            │
│     │  │                                                  │    │            │
│     │  │  Topic A (Клиент) ←─────────→ Topic B (Партнёр) │    │            │
│     │  │                      ↑                           │    │            │
│     │  │                      │                           │    │            │
│     │  │              SourcingRequest                     │    │            │
│     │  │           (связка + контроль)                    │    │            │
│     │  └─────────────────────────────────────────────────┘    │            │
│     └─────────────────────────────────────────────────────────┘            │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Message Relay System

### 3.1 Принцип работы

Message Relay — это система **анонимного проброса сообщений** между двумя Telegram темами через бота.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      MESSAGE RELAY ARCHITECTURE                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ТЕМА КЛИЕНТА                              ТЕМА ПАРТНЁРА                   │
│   (Topic ID: 123)                           (Topic ID: 456)                 │
│                                                                             │
│   ┌─────────────────────┐                   ┌─────────────────────┐         │
│   │ 👤 Клиент:          │                   │ 🤖 Bot:             │         │
│   │ "Нужны чехлы..."    │  ──────────────▶  │ "Нужны чехлы..."    │         │
│   └─────────────────────┘                   └─────────────────────┘         │
│                                                                             │
│   ┌─────────────────────┐                   ┌─────────────────────┐         │
│   │ 🤖 Bot:             │  ◀──────────────  │ 👤 Партнёр:         │         │
│   │ "Нашёл 3 варианта"  │                   │ "Нашёл 3 варианта"  │         │
│   └─────────────────────┘                   └─────────────────────┘         │
│                                                                             │
│                    ┌─────────────────────────────┐                          │
│                    │      SourcingRequest        │                          │
│                    │                             │                          │
│                    │  client_topic_id: 123       │                          │
│                    │  partner_topic_id: 456      │                          │
│                    │  relay_active: true         │                          │
│                    └─────────────────────────────┘                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Логика проброса

```typescript
// Псевдокод обработки сообщения
async function handleIncomingMessage(message: TelegramMessage) {
  // 1. Найти SourcingRequest по topic_id
  const sourcingRequest = await findByTopicId(message.topic_id);

  if (!sourcingRequest || !sourcingRequest.relay_active) {
    return; // Relay не активен
  }

  // 2. Определить направление
  let targetTopicId: number;
  let targetChatId: string;

  if (message.topic_id === sourcingRequest.client_topic_id) {
    // Сообщение от клиента → отправить партнёру
    targetTopicId = sourcingRequest.partner_topic_id;
    targetChatId = sourcingRequest.partner_chat_id;
  } else if (message.topic_id === sourcingRequest.partner_topic_id) {
    // Сообщение от партнёра → отправить клиенту
    targetTopicId = sourcingRequest.client_topic_id;
    targetChatId = sourcingRequest.client_chat_id;
  }

  // 3. Отправить сообщение ОТ ИМЕНИ БОТА
  await bot.sendMessage({
    chat_id: targetChatId,
    message_thread_id: targetTopicId,
    text: message.text,
    // Без указания reply_to — сообщение выглядит как от бота
  });

  // 4. Сохранить в истории для отображения в Platform Web
  await saveRelayedMessage({
    sourcing_request_id: sourcingRequest.id,
    direction: message.topic_id === sourcingRequest.client_topic_id ? 'client_to_partner' : 'partner_to_client',
    original_message_id: message.message_id,
    content: message.text,
  });
}
```

### 3.3 Состояния Relay

| Состояние | relay_active | Описание |
|-----------|--------------|----------|
| **Неактивен** | `false` | Партнёр не назначен или заявка завершена |
| **Активен** | `true` | Сообщения пробрасываются между темами |
| **Приостановлен** | `false` + `paused_reason` | Временно остановлен менеджером |

### 3.4 Что видит каждый участник

| Участник | В своей теме видит | Знает о другом |
|----------|-------------------|----------------|
| **Клиент** | Свои сообщения + ответы "от бота" | ❌ Не знает о партнёре |
| **Партнёр** | Свои сообщения + запросы "от бота" | ❌ Не знает о клиенте |
| **Менеджер** | ВСЮ переписку + метаданные | ✅ Видит обе стороны |

---

## 4. Структура данных

### 4.1 SourcingRequest (Заявка на поиск)

```typescript
interface SourcingRequest {
  // Идентификация
  id: string;                          // UUID
  request_number: string;              // SR-2024-0001

  // Статус воронки
  status: SourcingStatus;
  status_changed_at: string;           // ISO datetime

  // ═══════════════════════════════════════════════════════════
  // СВЯЗЬ С CHAT (ключевое!)
  // ═══════════════════════════════════════════════════════════

  // Клиент
  client_company_id: string;           // ID компании клиента
  client_chat_id: string;              // WellWon chat ID клиента
  client_telegram_chat_id: number;     // Telegram chat ID группы клиента
  client_topic_id: number;             // Telegram topic ID темы клиента

  // Партнёр
  partner_id?: string;                 // ID партнёра (User)
  partner_chat_id?: string;            // WellWon chat ID партнёра
  partner_telegram_chat_id?: number;   // Telegram chat ID группы партнёра
  partner_topic_id?: number;           // Telegram topic ID темы партнёра

  // ═══════════════════════════════════════════════════════════
  // MESSAGE RELAY
  // ═══════════════════════════════════════════════════════════

  relay_active: boolean;               // Проброс сообщений включен
  relay_started_at?: string;           // Когда включили relay
  relay_ended_at?: string;             // Когда выключили relay
  relay_message_count: number;         // Счётчик пересланных сообщений

  // ═══════════════════════════════════════════════════════════
  // ДАННЫЕ ЗАЯВКИ
  // ═══════════════════════════════════════════════════════════

  // Товар
  product_name: string;                // Название товара
  product_description: string;         // Описание
  product_category?: string;           // Категория
  specifications: Record<string, string>; // Характеристики (ключ: значение)
  reference_images?: string[];         // URLs референсных изображений
  reference_links?: string[];          // Ссылки на примеры

  // Требования
  target_quantity: string;             // "1000 шт", "500 кг"
  target_price_range: {
    min: number;
    max: number;
    currency: string;                  // "USD", "CNY", "RUB"
  };
  quality_requirements?: string;       // Требования к качеству

  // Сроки
  deadline?: string;                   // Дедлайн по заявке
  urgency: 'low' | 'medium' | 'high';  // Срочность

  // ═══════════════════════════════════════════════════════════
  // НАЗНАЧЕНИЯ
  // ═══════════════════════════════════════════════════════════

  assigned_manager_id: string;         // ID менеджера
  created_by_id: string;               // Кто создал заявку

  // ═══════════════════════════════════════════════════════════
  // РЕЗУЛЬТАТ
  // ═══════════════════════════════════════════════════════════

  suppliers?: Supplier[];              // Найденные поставщики
  selected_supplier_id?: string;       // Выбранный поставщик
  final_price?: number;                // Финальная цена
  final_quantity?: string;             // Финальное количество

  // Метаданные
  created_at: string;
  updated_at: string;
  completed_at?: string;
  cancelled_at?: string;
  cancellation_reason?: string;

  // Дополнительные поля для UI
  notes?: string;                      // Заметки менеджера
  tags?: string[];                     // Теги для фильтрации
}
```

### 4.2 SourcingStatus (Статусы воронки)

```typescript
type SourcingStatus =
  | 'NEW'           // Новая - заявка создана, партнёр не назначен
  | 'SOURCING'      // В работе - партнёр ищет товар
  | 'CLARIFYING'    // На уточнении - ожидание ответа от клиента
  | 'QUOTING'       // Котировка - собраны предложения от поставщиков
  | 'SAMPLING'      // Образцы - заказаны образцы товара
  | 'APPROVED'      // Одобрено - клиент выбрал поставщика
  | 'COMPLETED'     // Завершена - закупка завершена, relay отключен
  | 'CANCELLED';    // Отменена - заявка отменена

interface StatusConfig {
  code: SourcingStatus;
  label: string;
  color: string;
  bgColor: string;
  description: string;
  allowedTransitions: SourcingStatus[];
}

const STATUS_CONFIG: Record<SourcingStatus, StatusConfig> = {
  NEW: {
    code: 'NEW',
    label: 'Новая',
    color: 'text-gray-400',
    bgColor: 'bg-gray-500/10',
    description: 'Заявка создана, партнёр не назначен',
    allowedTransitions: ['SOURCING', 'CANCELLED'],
  },
  SOURCING: {
    code: 'SOURCING',
    label: 'В работе',
    color: 'text-yellow-500',
    bgColor: 'bg-yellow-500/10',
    description: 'Партнёр ищет товар',
    allowedTransitions: ['CLARIFYING', 'QUOTING', 'CANCELLED'],
  },
  CLARIFYING: {
    code: 'CLARIFYING',
    label: 'На уточнении',
    color: 'text-purple-500',
    bgColor: 'bg-purple-500/10',
    description: 'Ожидание ответа от клиента',
    allowedTransitions: ['SOURCING', 'QUOTING', 'CANCELLED'],
  },
  QUOTING: {
    code: 'QUOTING',
    label: 'Котировка',
    color: 'text-blue-500',
    bgColor: 'bg-blue-500/10',
    description: 'Собраны предложения от поставщиков',
    allowedTransitions: ['SAMPLING', 'APPROVED', 'CLARIFYING', 'CANCELLED'],
  },
  SAMPLING: {
    code: 'SAMPLING',
    label: 'Образцы',
    color: 'text-cyan-500',
    bgColor: 'bg-cyan-500/10',
    description: 'Заказаны образцы товара',
    allowedTransitions: ['APPROVED', 'QUOTING', 'CANCELLED'],
  },
  APPROVED: {
    code: 'APPROVED',
    label: 'Одобрено',
    color: 'text-green-500',
    bgColor: 'bg-green-500/10',
    description: 'Клиент выбрал поставщика',
    allowedTransitions: ['COMPLETED', 'CANCELLED'],
  },
  COMPLETED: {
    code: 'COMPLETED',
    label: 'Завершена',
    color: 'text-accent-green',
    bgColor: 'bg-accent-green/10',
    description: 'Закупка завершена успешно',
    allowedTransitions: [],
  },
  CANCELLED: {
    code: 'CANCELLED',
    label: 'Отменена',
    color: 'text-accent-red',
    bgColor: 'bg-accent-red/10',
    description: 'Заявка отменена',
    allowedTransitions: [],
  },
};
```

### 4.3 Supplier (Поставщик)

```typescript
interface Supplier {
  id: string;
  name: string;                        // Название поставщика
  contact_name?: string;               // Контактное лицо
  location?: string;                   // Город/провинция

  // Предложение
  price_per_unit: number;
  currency: string;
  min_order_quantity: string;
  lead_time: string;                   // "7-10 дней"

  // Оценка
  rating?: number;                     // 1-5
  notes?: string;

  // Медиа
  product_images?: string[];
  quotation_file?: string;             // PDF котировки

  created_at: string;
}
```

### 4.4 RelayedMessage (Пересланное сообщение)

```typescript
interface RelayedMessage {
  id: string;
  sourcing_request_id: string;

  // Направление
  direction: 'client_to_partner' | 'partner_to_client';

  // Оригинал
  original_message_id: number;         // Telegram message_id
  original_chat_id: number;
  original_topic_id: number;
  sender_name: string;                 // Имя отправителя для отображения

  // Контент
  content_type: 'text' | 'photo' | 'document' | 'voice';
  text?: string;
  media_url?: string;
  file_name?: string;

  // Релей
  relayed_message_id?: number;         // ID сообщения после пересылки
  relayed_at: string;
  relay_status: 'pending' | 'sent' | 'failed';

  created_at: string;
}
```

### 4.5 Partner (Партнёр-закупщик)

```typescript
interface Partner {
  id: string;
  name: string;
  telegram_user_id: number;
  telegram_username?: string;
  telegram_chat_id: number;            // ID его группы для создания тем

  // Специализация
  specialization?: string[];           // ["электроника", "текстиль"]
  location?: string;                   // Город в Китае

  // Статистика
  total_requests: number;
  completed_requests: number;
  average_rating?: number;

  // Статус
  is_active: boolean;
  last_active_at?: string;

  created_at: string;
}
```

---

## 5. UI экраны

### 5.1 Общая структура раздела

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  SIDEBAR  │                        CONTENT                                   │
│           │  ┌────────────────────────────────────────────────────────────┐  │
│  ┌─────┐  │  │ Header: "Закупки" + Stats + Actions                       │  │
│  │ 📊  │  │  └────────────────────────────────────────────────────────────┘  │
│  │Dash │  │  ┌────────────────────────────────────────────────────────────┐  │
│  ├─────┤  │  │ Dashboard (метрики, срочные)                               │  │
│  │ 📋  │  │  │     или                                                    │  │
│  │List │  │  │ List (Kanban / Table)                                      │  │
│  ├─────┤  │  │     или                                                    │  │
│  │ 📄  │  │  │ Card (детали заявки)                                       │  │
│  │Card │  │  └────────────────────────────────────────────────────────────┘  │
│  └─────┘  │                                                                   │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Dashboard

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                               ЗАКУПКИ                                        │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐                          │
│  │   15    │  │    8    │  │    3    │  │   12    │                          │
│  │ Всего   │  │ Активных│  │ Срочных │  │Завершено│                          │
│  │ заявок  │  │         │  │         │  │за месяц │                          │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘                          │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │ 🔥 ТРЕБУЮТ ВНИМАНИЯ                                          [See all] │  │
│  ├────────────────────────────────────────────────────────────────────────┤  │
│  │ SR-2024-0001  │  Силиконовые чехлы   │  Дедлайн: 2 дня  │  [В работе]  │  │
│  │ SR-2024-0003  │  USB кабели Type-C   │  Дедлайн: 1 день │  [Уточнение] │  │
│  │ SR-2024-0005  │  LED лампы E27       │  Нет ответа 3д   │  [Котировка] │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌────────────────────────────────────┐  ┌─────────────────────────────────┐ │
│  │ 📊 ПО СТАТУСАМ                     │  │ 👥 ПО ПАРТНЁРАМ                 │ │
│  ├────────────────────────────────────┤  ├─────────────────────────────────┤ │
│  │ В работе        ████████░░  8      │  │ Ли Вэй           ████░░  4     │ │
│  │ На уточнении    ███░░░░░░░  3      │  │ Чжан Мин         ███░░░  3     │ │
│  │ Котировка       ██░░░░░░░░  2      │  │ Ван Сяо          ██░░░░  2     │ │
│  │ Образцы         █░░░░░░░░░  1      │  │ Без партнёра     █░░░░░  1     │ │
│  │ Одобрено        █░░░░░░░░░  1      │  └─────────────────────────────────┘ │
│  └────────────────────────────────────┘                                      │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 Список заявок — Kanban View

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  [🔍 Поиск...]  [📅 Дата ▼]  [👤 Партнёр ▼]  [🏢 Клиент ▼]  [✕]             │
│                                                                              │
│  [Kanban ☑]  [Таблица ○]                          [+ Создать заявку]        │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─ Новая (1) ──┐  ┌─ В работе (4) ┐  ┌─ Котировка (2) ┐  ┌─ Одобрено (1)─┐ │
│  │              │  │               │  │                │  │               │ │
│  │ ┌──────────┐ │  │ ┌───────────┐ │  │ ┌────────────┐ │  │ ┌───────────┐ │ │
│  │ │SR-0006   │ │  │ │SR-0001    │ │  │ │SR-0002     │ │  │ │SR-0004    │ │ │
│  │ │          │ │  │ │           │ │  │ │            │ │  │ │           │ │ │
│  │ │Powerbank │ │  │ │Чехлы      │ │  │ │LED лампы   │ │  │ │Наушники   │ │ │
│  │ │20000mAh  │ │  │ │iPhone 15  │ │  │ │E27 12W     │ │  │ │TWS        │ │ │
│  │ │          │ │  │ │           │ │  │ │            │ │  │ │           │ │ │
│  │ │🏢 ТехноГр│ │  │ │🏢 ТехноГр │ │  │ │🏢 Светлов │ │  │ │🏢 SoundPro│ │ │
│  │ │⏰ 10 дек │ │  │ │👤 Ли Вэй  │ │  │ │👤 Чжан Мин│ │  │ │👤 Ван Сяо │ │ │
│  │ │          │ │  │ │⏰ 5 дек   │ │  │ │⏰ 3 дек   │ │  │ │⏰ 15 дек  │ │ │
│  │ └──────────┘ │  │ └───────────┘ │  │ └────────────┘ │  │ └───────────┘ │ │
│  │              │  │ ┌───────────┐ │  │ ┌────────────┐ │  │               │ │
│  │              │  │ │SR-0003    │ │  │ │SR-0007     │ │  │               │ │
│  │              │  │ │USB кабели │ │  │ │Зарядки QC3 │ │  │               │ │
│  │              │  │ │...        │ │  │ │...         │ │  │               │ │
│  │              │  │ └───────────┘ │  │ └────────────┘ │  │               │ │
│  └──────────────┘  └───────────────┘  └────────────────┘  └───────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 5.4 Список заявок — Table View

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  [🔍 Поиск...]  [📅 Дата ▼]  [👤 Партнёр ▼]  [🏢 Клиент ▼]  [✕]             │
│                                                                              │
│  [Kanban ○]  [Таблица ☑]                          [+ Создать заявку]        │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  № Заявки    │ Товар              │ Клиент      │ Партнёр   │ Статус     │ ⋮│
│  ────────────┼────────────────────┼─────────────┼───────────┼────────────┼──│
│  SR-2024-0001│ Силиконовые чехлы  │ ТехноГрупп  │ Ли Вэй    │ [В работе] │⋮ │
│  SR-2024-0002│ LED лампы E27 12W  │ ИП Светлов  │ Чжан Мин  │ [Котировка]│⋮ │
│  SR-2024-0003│ USB кабели Type-C  │ КабельПро   │ Ли Вэй    │ [Уточнение]│⋮ │
│  SR-2024-0004│ TWS наушники       │ SoundPro    │ Ван Сяо   │ [Одобрено] │⋮ │
│  SR-2024-0005│ Powerbank 20000mAh │ ТехноГрупп  │ —         │ [Новая]    │⋮ │
│                                                                              │
│  ────────────────────────────────────────────────────────────────────────────│
│  [10 ▼] строк на странице     Показано 1-10 из 15     [<] [1] [2] [>]       │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 5.5 Карточка заявки (Detail View)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  [← Назад]                                                                   │
│                                                                              │
│  SR-2024-0001                                          [В работе ▼]         │
│  ══════════════════════════════════════════════════════════════════════════ │
│  Силиконовые чехлы для iPhone 15 Pro Max                                    │
│                                                                              │
│  [Редактировать]  [В чат клиента]  [В чат партнёра]  [⋮ Ещё]               │
│                                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────┐  ┌─────────────────────────┐│
│  │ [Обзор] [Переписка] [Поставщики] [История]  │  │ ИНФОРМАЦИЯ              ││
│  ├─────────────────────────────────────────────┤  ├─────────────────────────┤│
│  │                                             │  │                         ││
│  │  📦 ТОВАР                                   │  │ 🏢 Клиент               ││
│  │  ─────────────────────────────              │  │ ООО "ТехноГрупп"        ││
│  │  Название: Силиконовые чехлы iPhone 15 PM  │  │ [→ В чат]               ││
│  │  Категория: Аксессуары                      │  │                         ││
│  │  Описание: Мягкий силикон, матовая          │  │ 👤 Партнёр              ││
│  │            поверхность, защита камеры       │  │ Ли Вэй                  ││
│  │                                             │  │ [→ В чат] [Сменить]     ││
│  │  📋 ТРЕБОВАНИЯ                              │  │                         ││
│  │  ─────────────────────────────              │  │ 📅 Даты                 ││
│  │  Количество: 5000 шт                        │  │ Создано: 25.11.2024     ││
│  │  Цена: $0.50 - $1.00 / шт                  │  │ Обновлено: 28.11.2024   ││
│  │  Качество: Премиум, без запаха              │  │ Дедлайн: 10.12.2024     ││
│  │                                             │  │                         ││
│  │  🖼️ РЕФЕРЕНСЫ                              │  │ 📊 Relay                ││
│  │  ─────────────────────────────              │  │ Статус: Активен ✓       ││
│  │  [img1] [img2] [img3]                       │  │ Сообщений: 47           ││
│  │  🔗 aliexpress.com/item/123                 │  │                         ││
│  │                                             │  │ ─────────────────────── ││
│  │                                             │  │ [🔴 Завершить заявку]   ││
│  │                                             │  │                         ││
│  └─────────────────────────────────────────────┘  └─────────────────────────┘│
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 5.6 Таб "Переписка" (Message Thread)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  [Обзор] [Переписка ●] [Поставщики] [История]                               │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Фильтр: [Все] [Клиент] [Партнёр]                                           │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │ 📅 28 ноября 2024                                                      │  │
│  ├────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                        │  │
│  │  ┌─ 🏢 КЛИЕНТ (ТехноГрупп) ──────────────────────────────── 10:15 ─┐  │  │
│  │  │ Добрый день! Нужны чехлы для iPhone 15 Pro Max,                 │  │  │
│  │  │ силиконовые, матовые. Около 5000 штук.                          │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  ┌─ 👤 ПАРТНЁР (Ли Вэй) ─────────────────────────────────── 10:32 ─┐  │  │
│  │  │ Понял. Уточните пожалуйста:                                      │  │  │
│  │  │ 1. Какие цвета нужны?                                            │  │  │
│  │  │ 2. С защитой камеры или без?                                     │  │  │
│  │  │ 3. Нужна ли упаковка?                                            │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  ┌─ 🏢 КЛИЕНТ (ТехноГрупп) ──────────────────────────────── 11:05 ─┐  │  │
│  │  │ 1. Черный, темно-синий, бордовый                                 │  │  │
│  │  │ 2. С защитой камеры обязательно                                  │  │  │
│  │  │ 3. Индивидуальная упаковка, можно простая                        │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  ┌─ 👤 ПАРТНЁР (Ли Вэй) ─────────────────────────────────── 14:20 ─┐  │  │
│  │  │ Отлично! Нашел 3 фабрики. Отправляю фото образцов.              │  │  │
│  │  │ [📷 photo_1.jpg] [📷 photo_2.jpg] [📷 photo_3.jpg]              │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  💡 Вся переписка автоматически пробрасывается между клиентом и партнёром   │
│     через бота. Они не видят друг друга.                                    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 5.7 Форма создания заявки

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        СОЗДАНИЕ ЗАЯВКИ НА ПОИСК                              │
│  ══════════════════════════════════════════════════════════════════════════ │
│                                                                       [✕]   │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │ 📦 ТОВАР                                                               │  │
│  ├────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                        │  │
│  │  Название товара *                                                     │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │ Силиконовые чехлы для iPhone 15 Pro Max                          │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  Описание и требования *                                               │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │ Мягкий силикон, матовая поверхность, защита камеры.              │  │  │
│  │  │ Цвета: черный, синий, бордовый.                                  │  │  │
│  │  │                                                                  │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  Категория                          Ссылки на референсы               │  │
│  │  ┌─────────────────────────┐        ┌────────────────────────────────┐ │  │
│  │  │ Аксессуары           ▼  │        │ https://aliexpress.com/...     │ │  │
│  │  └─────────────────────────┘        └────────────────────────────────┘ │  │
│  │                                                                        │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │ 📋 ТРЕБОВАНИЯ                                                          │  │
│  ├────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                        │  │
│  │  Количество *                       Ценовой диапазон (USD)            │  │
│  │  ┌─────────────────────────┐        ┌──────────┐  —  ┌──────────┐     │  │
│  │  │ 5000 шт                 │        │ 0.50     │     │ 1.00     │     │  │
│  │  └─────────────────────────┘        └──────────┘     └──────────┘     │  │
│  │                                                                        │  │
│  │  Требования к качеству                                                 │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │ Премиум качество, без запаха, плотное прилегание                 │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │ 👤 НАЗНАЧЕНИЕ                                                          │  │
│  ├────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                        │  │
│  │  Партнёр *                          Срочность                         │  │
│  │  ┌─────────────────────────┐        ┌─────────────────────────┐       │  │
│  │  │ Ли Вэй              ▼   │        │ Обычная               ▼ │       │  │
│  │  └─────────────────────────┘        └─────────────────────────┘       │  │
│  │                                                                        │  │
│  │  Дедлайн                                                               │  │
│  │  ┌─────────────────────────┐                                          │  │
│  │  │ 10.12.2024          📅  │                                          │  │
│  │  └─────────────────────────┘                                          │  │
│  │                                                                        │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│                        [Отмена]        [Создать заявку]                      │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Компоненты по DESIGN_SYSTEM

### 6.1 Theme Object

```typescript
const theme = isDark ? {
  // Backgrounds
  page: 'bg-[#1a1a1e]',
  card: {
    background: 'bg-[#232328]',
    border: 'border-white/10',
  },
  input: 'bg-[#1e1e22] border-white/10',

  // Text
  text: {
    primary: 'text-white',
    secondary: 'text-gray-400',
    muted: 'text-gray-500',
  },

  // Buttons
  button: {
    primary: 'bg-accent-red text-white hover:bg-accent-red/90',
    secondary: 'text-gray-300 hover:text-white hover:bg-white/10',
    ghost: 'bg-[#1e1e22] border-white/10 text-gray-300 hover:bg-[#252529] hover:text-white',
    danger: 'bg-accent-red/10 text-accent-red border-accent-red/20 hover:bg-accent-red/20',
  },

  // Table
  table: {
    header: 'text-gray-400 border-white/10',
    row: 'hover:bg-white/5',
    cell: 'text-white border-white/10',
  },

  // Kanban
  kanban: {
    column: 'bg-[#232328] border-white/10',
    card: 'bg-[#1e1e22] border-white/10 hover:border-white/20',
  },
} : {
  // Light theme equivalents...
  page: 'bg-[#f4f4f4]',
  card: {
    background: 'bg-white',
    border: 'border-gray-300 shadow-sm',
  },
  input: 'bg-gray-50 border-gray-300',
  text: {
    primary: 'text-gray-900',
    secondary: 'text-gray-600',
    muted: 'text-gray-500',
  },
  button: {
    primary: 'bg-accent-red text-white hover:bg-accent-red/90 shadow-sm',
    secondary: 'text-gray-600 hover:text-gray-900 hover:bg-gray-100',
    ghost: 'bg-gray-50 border-gray-300 text-gray-600 hover:bg-gray-100 hover:text-gray-900',
    danger: 'bg-accent-red/10 text-accent-red border-accent-red/20 hover:bg-accent-red/20',
  },
  table: {
    header: 'text-gray-500 border-gray-300',
    row: 'hover:bg-gray-50',
    cell: 'text-gray-900 border-gray-300',
  },
  kanban: {
    column: 'bg-white border-gray-200 shadow-sm',
    card: 'bg-gray-50 border-gray-200 hover:border-gray-300',
  },
};
```

### 6.2 Status Badge

```tsx
interface StatusBadgeProps {
  status: SourcingStatus;
}

const StatusBadge: React.FC<StatusBadgeProps> = ({ status }) => {
  const config = STATUS_CONFIG[status];

  return (
    <span className={`
      px-2.5 py-1 rounded-full text-xs font-medium
      ${config.bgColor} ${config.color}
    `}>
      {config.label}
    </span>
  );
};
```

### 6.3 Kanban Card

```tsx
interface KanbanCardProps {
  request: SourcingRequest;
  onClick: () => void;
}

const KanbanCard: React.FC<KanbanCardProps> = ({ request, onClick }) => {
  return (
    <div
      onClick={onClick}
      className={`
        p-4 rounded-xl border cursor-pointer transition-all
        ${theme.kanban.card}
      `}
    >
      {/* Header */}
      <div className="flex items-center justify-between mb-2">
        <span className={`text-xs font-mono ${theme.text.secondary}`}>
          {request.request_number}
        </span>
        <StatusBadge status={request.status} />
      </div>

      {/* Title */}
      <h4 className={`text-sm font-medium mb-3 line-clamp-2 ${theme.text.primary}`}>
        {request.product_name}
      </h4>

      {/* Footer */}
      <div className="flex items-center justify-between text-xs">
        <div className="flex items-center gap-1.5">
          <Building2 className="w-3.5 h-3.5 text-gray-400" />
          <span className={theme.text.secondary}>
            {request.client_company_name}
          </span>
        </div>

        {request.deadline && (
          <div className="flex items-center gap-1.5">
            <Clock className="w-3.5 h-3.5 text-gray-400" />
            <span className={theme.text.secondary}>
              {formatDate(request.deadline)}
            </span>
          </div>
        )}
      </div>

      {/* Partner */}
      {request.partner_name && (
        <div className="flex items-center gap-1.5 mt-2 pt-2 border-t border-white/5">
          <User className="w-3.5 h-3.5 text-gray-400" />
          <span className={`text-xs ${theme.text.secondary}`}>
            {request.partner_name}
          </span>
          {request.relay_active && (
            <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse" />
          )}
        </div>
      )}
    </div>
  );
};
```

### 6.4 Table Row

```tsx
const TableRow: React.FC<{ request: SourcingRequest }> = ({ request }) => {
  return (
    <tr className={`border-b ${theme.table.border} ${theme.table.row}`}>
      {/* № Заявки */}
      <td className={`px-4 py-3 text-sm font-mono ${theme.text.secondary}`}>
        {request.request_number}
      </td>

      {/* Товар */}
      <td className={`px-4 py-3 ${theme.text.primary}`}>
        <div className="text-sm font-medium line-clamp-1">
          {request.product_name}
        </div>
      </td>

      {/* Клиент */}
      <td className={`px-4 py-3 text-sm ${theme.text.secondary}`}>
        {request.client_company_name}
      </td>

      {/* Партнёр */}
      <td className={`px-4 py-3 text-sm ${theme.text.secondary}`}>
        <div className="flex items-center gap-2">
          {request.partner_name || '—'}
          {request.relay_active && (
            <span className="w-2 h-2 rounded-full bg-green-500" title="Relay активен" />
          )}
        </div>
      </td>

      {/* Статус */}
      <td className="px-4 py-3">
        <StatusBadge status={request.status} />
      </td>

      {/* Дедлайн */}
      <td className={`px-4 py-3 text-sm ${theme.text.secondary}`}>
        {request.deadline ? formatDate(request.deadline) : '—'}
      </td>

      {/* Действия */}
      <td className="px-4 py-3">
        <div className="flex items-center gap-1">
          <button className={`h-8 w-8 rounded-lg flex items-center justify-center ${theme.button.ghost}`}>
            <Eye className="w-4 h-4" />
          </button>
          <button className={`h-8 w-8 rounded-lg flex items-center justify-center ${theme.button.ghost}`}>
            <MoreVertical className="w-4 h-4" />
          </button>
        </div>
      </td>
    </tr>
  );
};
```

### 6.5 Message Thread Item

```tsx
interface MessageItemProps {
  message: RelayedMessage;
  isClient: boolean;
}

const MessageItem: React.FC<MessageItemProps> = ({ message, isClient }) => {
  const borderColor = isClient ? 'border-l-blue-500' : 'border-l-purple-500';
  const icon = isClient ? Building2 : User;
  const label = isClient ? 'КЛИЕНТ' : 'ПАРТНЁР';

  return (
    <div className={`
      p-4 rounded-xl border-l-4 ${borderColor}
      ${isDark ? 'bg-white/5' : 'bg-gray-50'}
    `}>
      {/* Header */}
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <icon className="w-4 h-4 text-gray-400" />
          <span className={`text-xs font-medium uppercase ${theme.text.secondary}`}>
            {label}
          </span>
          <span className={`text-xs ${theme.text.muted}`}>
            ({message.sender_name})
          </span>
        </div>
        <span className={`text-xs ${theme.text.muted}`}>
          {formatTime(message.created_at)}
        </span>
      </div>

      {/* Content */}
      <p className={`text-sm whitespace-pre-wrap ${theme.text.primary}`}>
        {message.text}
      </p>

      {/* Media */}
      {message.media_url && (
        <div className="mt-2">
          {message.content_type === 'photo' ? (
            <img
              src={message.media_url}
              alt=""
              className="max-w-xs rounded-lg"
            />
          ) : (
            <a
              href={message.media_url}
              className="flex items-center gap-2 text-blue-500 text-sm"
            >
              <FileText className="w-4 h-4" />
              {message.file_name}
            </a>
          )}
        </div>
      )}
    </div>
  );
};
```

### 6.6 Filter Bar

```tsx
const FilterBar: React.FC = () => {
  return (
    <div className="flex items-center gap-3 flex-wrap">
      {/* Search */}
      <div className="relative flex-1 min-w-[200px]">
        <Search className={`absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 ${theme.text.secondary}`} />
        <input
          type="text"
          placeholder="Поиск по номеру или товару..."
          className={`
            w-full h-10 pl-10 pr-4 rounded-xl border text-sm
            focus:outline-none focus:ring-0 transition-none
            ${theme.input}
          `}
        />
      </div>

      {/* Status Filter */}
      <Select>
        <SelectTrigger className={`w-[160px] h-10 rounded-xl ${theme.input}`}>
          <SelectValue placeholder="Статус" />
        </SelectTrigger>
        <SelectContent>
          {Object.values(STATUS_CONFIG).map(status => (
            <SelectItem key={status.code} value={status.code}>
              {status.label}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>

      {/* Partner Filter */}
      <Select>
        <SelectTrigger className={`w-[160px] h-10 rounded-xl ${theme.input}`}>
          <SelectValue placeholder="Партнёр" />
        </SelectTrigger>
        <SelectContent>
          {partners.map(partner => (
            <SelectItem key={partner.id} value={partner.id}>
              {partner.name}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>

      {/* Reset */}
      {hasActiveFilters && (
        <button className={`
          w-10 h-10 rounded-lg flex items-center justify-center
          ${theme.button.danger}
        `}>
          <X className="w-4 h-4" />
        </button>
      )}
    </div>
  );
};
```

### 6.7 View Toggle

```tsx
type ViewMode = 'kanban' | 'table';

const ViewToggle: React.FC<{ value: ViewMode; onChange: (v: ViewMode) => void }> = ({ value, onChange }) => {
  return (
    <div className={`
      flex items-center p-1 rounded-xl border
      ${isDark ? 'bg-[#1e1e22] border-white/10' : 'bg-gray-100 border-gray-200'}
    `}>
      <button
        onClick={() => onChange('kanban')}
        className={`
          h-8 px-3 rounded-lg flex items-center gap-2 text-sm font-medium transition-all
          ${value === 'kanban'
            ? 'bg-accent-red text-white'
            : theme.button.secondary
          }
        `}
      >
        <LayoutGrid className="w-4 h-4" />
        Kanban
      </button>
      <button
        onClick={() => onChange('table')}
        className={`
          h-8 px-3 rounded-lg flex items-center gap-2 text-sm font-medium transition-all
          ${value === 'table'
            ? 'bg-accent-red text-white'
            : theme.button.secondary
          }
        `}
      >
        <List className="w-4 h-4" />
        Таблица
      </button>
    </div>
  );
};
```

---

## 7. Мок-данные

### 7.1 Заявки на поиск

```typescript
export const mockSourcingRequests: SourcingRequest[] = [
  {
    id: '1',
    request_number: 'SR-2024-0001',
    status: 'SOURCING',
    status_changed_at: '2024-11-26T14:30:00Z',

    client_company_id: 'comp-1',
    client_company_name: 'ООО "ТехноГрупп"',
    client_chat_id: 'chat-client-1',
    client_telegram_chat_id: -1001234567890,
    client_topic_id: 123,

    partner_id: 'partner-1',
    partner_name: 'Ли Вэй',
    partner_chat_id: 'chat-partner-1',
    partner_telegram_chat_id: -1009876543210,
    partner_topic_id: 456,

    relay_active: true,
    relay_started_at: '2024-11-26T14:30:00Z',
    relay_message_count: 47,

    product_name: 'Силиконовые чехлы для iPhone 15 Pro Max',
    product_description: 'Мягкий силикон, матовая поверхность, защита камеры. Цвета: черный, темно-синий, бордовый.',
    product_category: 'Аксессуары',
    specifications: {
      'Материал': 'Силикон',
      'Тип': 'Матовый',
      'Защита камеры': 'Да',
      'Цвета': 'Черный, синий, бордовый',
    },
    reference_links: ['https://aliexpress.com/item/123456'],

    target_quantity: '5000 шт',
    target_price_range: { min: 0.5, max: 1.0, currency: 'USD' },
    quality_requirements: 'Премиум качество, без запаха, плотное прилегание',

    deadline: '2024-12-10',
    urgency: 'medium',

    assigned_manager_id: 'manager-1',
    created_by_id: 'manager-1',

    created_at: '2024-11-25T10:00:00Z',
    updated_at: '2024-11-28T16:45:00Z',
  },
  {
    id: '2',
    request_number: 'SR-2024-0002',
    status: 'QUOTING',
    status_changed_at: '2024-11-27T11:00:00Z',

    client_company_id: 'comp-2',
    client_company_name: 'ИП Светлов',
    client_chat_id: 'chat-client-2',
    client_telegram_chat_id: -1001111222333,
    client_topic_id: 789,

    partner_id: 'partner-2',
    partner_name: 'Чжан Мин',
    partner_chat_id: 'chat-partner-2',
    partner_telegram_chat_id: -1004445556667,
    partner_topic_id: 101,

    relay_active: true,
    relay_started_at: '2024-11-22T09:15:00Z',
    relay_message_count: 32,

    product_name: 'LED лампы E27 12W',
    product_description: 'Светодиодные лампы с цоколем E27, мощность 12W, теплый свет 3000K',
    product_category: 'Освещение',
    specifications: {
      'Цоколь': 'E27',
      'Мощность': '12W',
      'Цветовая температура': '3000K',
      'Срок службы': '25000 часов',
    },

    target_quantity: '10000 шт',
    target_price_range: { min: 0.8, max: 1.5, currency: 'USD' },

    deadline: '2024-12-05',
    urgency: 'high',

    assigned_manager_id: 'manager-1',
    created_by_id: 'manager-1',

    suppliers: [
      {
        id: 'sup-1',
        name: 'Guangzhou Light Factory',
        price_per_unit: 0.95,
        currency: 'USD',
        min_order_quantity: '5000 шт',
        lead_time: '7-10 дней',
        rating: 4,
        created_at: '2024-11-27T10:00:00Z',
      },
      {
        id: 'sup-2',
        name: 'Shenzhen LED Co.',
        price_per_unit: 1.10,
        currency: 'USD',
        min_order_quantity: '3000 шт',
        lead_time: '5-7 дней',
        rating: 5,
        created_at: '2024-11-27T14:00:00Z',
      },
    ],

    created_at: '2024-11-20T08:30:00Z',
    updated_at: '2024-11-28T12:00:00Z',
  },
  {
    id: '3',
    request_number: 'SR-2024-0003',
    status: 'CLARIFYING',
    status_changed_at: '2024-11-28T09:00:00Z',

    client_company_id: 'comp-3',
    client_company_name: 'КабельПро',
    client_chat_id: 'chat-client-3',
    client_telegram_chat_id: -1002223334445,
    client_topic_id: 111,

    partner_id: 'partner-1',
    partner_name: 'Ли Вэй',
    partner_chat_id: 'chat-partner-1',
    partner_telegram_chat_id: -1009876543210,
    partner_topic_id: 222,

    relay_active: true,
    relay_started_at: '2024-11-24T16:00:00Z',
    relay_message_count: 18,

    product_name: 'USB кабели Type-C',
    product_description: 'Кабели USB Type-C to Type-C, длина 1м, поддержка быстрой зарядки',
    product_category: 'Кабели',
    specifications: {
      'Тип': 'Type-C to Type-C',
      'Длина': '1 метр',
      'Быстрая зарядка': 'PD 60W',
    },

    target_quantity: '20000 шт',
    target_price_range: { min: 0.3, max: 0.6, currency: 'USD' },

    deadline: '2024-12-01',
    urgency: 'high',

    assigned_manager_id: 'manager-2',
    created_by_id: 'manager-2',

    notes: 'Клиент уточняет требования по упаковке',

    created_at: '2024-11-22T11:00:00Z',
    updated_at: '2024-11-28T09:00:00Z',
  },
  {
    id: '4',
    request_number: 'SR-2024-0004',
    status: 'APPROVED',
    status_changed_at: '2024-11-27T16:30:00Z',

    client_company_id: 'comp-4',
    client_company_name: 'SoundPro',
    client_chat_id: 'chat-client-4',
    client_telegram_chat_id: -1005556667778,
    client_topic_id: 333,

    partner_id: 'partner-3',
    partner_name: 'Ван Сяо',
    partner_chat_id: 'chat-partner-3',
    partner_telegram_chat_id: -1008889990001,
    partner_topic_id: 444,

    relay_active: true,
    relay_started_at: '2024-11-18T10:00:00Z',
    relay_message_count: 86,

    product_name: 'TWS наушники',
    product_description: 'Беспроводные TWS наушники с шумоподавлением, Bluetooth 5.3',
    product_category: 'Электроника',
    specifications: {
      'Тип': 'TWS',
      'Bluetooth': '5.3',
      'ANC': 'Да',
      'Время работы': '6 часов',
    },

    target_quantity: '2000 шт',
    target_price_range: { min: 8, max: 15, currency: 'USD' },

    deadline: '2024-12-15',
    urgency: 'medium',

    assigned_manager_id: 'manager-1',
    created_by_id: 'manager-1',

    selected_supplier_id: 'sup-3',
    final_price: 11.5,
    final_quantity: '2000 шт',

    suppliers: [
      {
        id: 'sup-3',
        name: 'Shenzhen Audio Tech',
        price_per_unit: 11.5,
        currency: 'USD',
        min_order_quantity: '1000 шт',
        lead_time: '10-14 дней',
        rating: 5,
        created_at: '2024-11-25T14:00:00Z',
      },
    ],

    created_at: '2024-11-15T09:00:00Z',
    updated_at: '2024-11-27T16:30:00Z',
  },
  {
    id: '5',
    request_number: 'SR-2024-0005',
    status: 'NEW',
    status_changed_at: '2024-11-28T08:00:00Z',

    client_company_id: 'comp-1',
    client_company_name: 'ООО "ТехноГрупп"',
    client_chat_id: 'chat-client-1',
    client_telegram_chat_id: -1001234567890,
    client_topic_id: 555,

    relay_active: false,
    relay_message_count: 0,

    product_name: 'Powerbank 20000mAh',
    product_description: 'Внешний аккумулятор 20000mAh с поддержкой быстрой зарядки PD 65W',
    product_category: 'Электроника',
    specifications: {
      'Ёмкость': '20000mAh',
      'Быстрая зарядка': 'PD 65W',
      'Порты': '2x USB-A, 1x USB-C',
    },

    target_quantity: '3000 шт',
    target_price_range: { min: 10, max: 18, currency: 'USD' },

    deadline: '2024-12-20',
    urgency: 'low',

    assigned_manager_id: 'manager-1',
    created_by_id: 'manager-1',

    created_at: '2024-11-28T08:00:00Z',
    updated_at: '2024-11-28T08:00:00Z',
  },
  {
    id: '6',
    request_number: 'SR-2024-0006',
    status: 'COMPLETED',
    status_changed_at: '2024-11-20T14:00:00Z',

    client_company_id: 'comp-5',
    client_company_name: 'ООО "Гаджет"',
    client_chat_id: 'chat-client-5',
    client_telegram_chat_id: -1006667778889,
    client_topic_id: 666,

    partner_id: 'partner-2',
    partner_name: 'Чжан Мин',
    partner_chat_id: 'chat-partner-2',
    partner_telegram_chat_id: -1004445556667,
    partner_topic_id: 777,

    relay_active: false,
    relay_started_at: '2024-11-05T10:00:00Z',
    relay_ended_at: '2024-11-20T14:00:00Z',
    relay_message_count: 124,

    product_name: 'Защитные стёкла iPhone 15',
    product_description: 'Закалённое защитное стекло 9H для iPhone 15 серии',
    product_category: 'Аксессуары',

    target_quantity: '10000 шт',
    target_price_range: { min: 0.2, max: 0.5, currency: 'USD' },

    urgency: 'medium',

    assigned_manager_id: 'manager-2',
    created_by_id: 'manager-2',

    selected_supplier_id: 'sup-4',
    final_price: 0.35,
    final_quantity: '10000 шт',

    created_at: '2024-11-01T10:00:00Z',
    updated_at: '2024-11-20T14:00:00Z',
    completed_at: '2024-11-20T14:00:00Z',
  },
];
```

### 7.2 Партнёры

```typescript
export const mockPartners: Partner[] = [
  {
    id: 'partner-1',
    name: 'Ли Вэй',
    telegram_user_id: 123456789,
    telegram_username: 'li_wei_sourcing',
    telegram_chat_id: -1009876543210,
    specialization: ['электроника', 'аксессуары'],
    location: 'Шэньчжэнь',
    total_requests: 45,
    completed_requests: 38,
    average_rating: 4.7,
    is_active: true,
    last_active_at: '2024-11-28T16:00:00Z',
    created_at: '2024-01-15T00:00:00Z',
  },
  {
    id: 'partner-2',
    name: 'Чжан Мин',
    telegram_user_id: 987654321,
    telegram_username: 'zhang_min_trade',
    telegram_chat_id: -1004445556667,
    specialization: ['освещение', 'электрика'],
    location: 'Гуанчжоу',
    total_requests: 32,
    completed_requests: 28,
    average_rating: 4.5,
    is_active: true,
    last_active_at: '2024-11-28T14:30:00Z',
    created_at: '2024-02-20T00:00:00Z',
  },
  {
    id: 'partner-3',
    name: 'Ван Сяо',
    telegram_user_id: 456789123,
    telegram_username: 'wang_xiao',
    telegram_chat_id: -1008889990001,
    specialization: ['аудио', 'электроника'],
    location: 'Шэньчжэнь',
    total_requests: 28,
    completed_requests: 25,
    average_rating: 4.8,
    is_active: true,
    last_active_at: '2024-11-28T12:00:00Z',
    created_at: '2024-03-10T00:00:00Z',
  },
];
```

### 7.3 Статистика

```typescript
export const mockStats = {
  total_requests: 15,
  active_requests: 8,
  needs_attention: 3,
  completed_this_month: 12,

  by_status: {
    NEW: 1,
    SOURCING: 4,
    CLARIFYING: 1,
    QUOTING: 2,
    SAMPLING: 0,
    APPROVED: 1,
    COMPLETED: 5,
    CANCELLED: 1,
  },

  by_partner: {
    'partner-1': 4,
    'partner-2': 3,
    'partner-3': 2,
    unassigned: 1,
  },

  avg_completion_time_days: 12,
  relay_messages_today: 47,
};
```

### 7.4 Пересланные сообщения

```typescript
export const mockRelayedMessages: RelayedMessage[] = [
  {
    id: 'msg-1',
    sourcing_request_id: '1',
    direction: 'client_to_partner',
    original_message_id: 1001,
    original_chat_id: -1001234567890,
    original_topic_id: 123,
    sender_name: 'Иван (ТехноГрупп)',
    content_type: 'text',
    text: 'Добрый день! Нужны чехлы для iPhone 15 Pro Max, силиконовые, матовые. Около 5000 штук.',
    relayed_message_id: 2001,
    relayed_at: '2024-11-28T10:15:00Z',
    relay_status: 'sent',
    created_at: '2024-11-28T10:15:00Z',
  },
  {
    id: 'msg-2',
    sourcing_request_id: '1',
    direction: 'partner_to_client',
    original_message_id: 3001,
    original_chat_id: -1009876543210,
    original_topic_id: 456,
    sender_name: 'Ли Вэй',
    content_type: 'text',
    text: 'Понял. Уточните пожалуйста:\n1. Какие цвета нужны?\n2. С защитой камеры или без?\n3. Нужна ли упаковка?',
    relayed_message_id: 4001,
    relayed_at: '2024-11-28T10:32:00Z',
    relay_status: 'sent',
    created_at: '2024-11-28T10:32:00Z',
  },
  {
    id: 'msg-3',
    sourcing_request_id: '1',
    direction: 'client_to_partner',
    original_message_id: 1002,
    original_chat_id: -1001234567890,
    original_topic_id: 123,
    sender_name: 'Иван (ТехноГрупп)',
    content_type: 'text',
    text: '1. Черный, темно-синий, бордовый\n2. С защитой камеры обязательно\n3. Индивидуальная упаковка, можно простая',
    relayed_message_id: 2002,
    relayed_at: '2024-11-28T11:05:00Z',
    relay_status: 'sent',
    created_at: '2024-11-28T11:05:00Z',
  },
  {
    id: 'msg-4',
    sourcing_request_id: '1',
    direction: 'partner_to_client',
    original_message_id: 3002,
    original_chat_id: -1009876543210,
    original_topic_id: 456,
    sender_name: 'Ли Вэй',
    content_type: 'text',
    text: 'Отлично! Нашел 3 фабрики. Отправляю фото образцов.',
    relayed_message_id: 4002,
    relayed_at: '2024-11-28T14:20:00Z',
    relay_status: 'sent',
    created_at: '2024-11-28T14:20:00Z',
  },
  {
    id: 'msg-5',
    sourcing_request_id: '1',
    direction: 'partner_to_client',
    original_message_id: 3003,
    original_chat_id: -1009876543210,
    original_topic_id: 456,
    sender_name: 'Ли Вэй',
    content_type: 'photo',
    media_url: '/uploads/photos/sample_1.jpg',
    relayed_message_id: 4003,
    relayed_at: '2024-11-28T14:21:00Z',
    relay_status: 'sent',
    created_at: '2024-11-28T14:21:00Z',
  },
];
```

---

## 8. Интеграция с Chat модулем

### 8.1 Кнопка создания заявки в Chat

В интерфейсе Chat (раздел "Group Chats" / "Personal Chats") добавить кнопку/действие для создания заявки на поиск.

**Расположение:**
- В панели действий темы (справа вверху)
- Или в контекстном меню (⋮)

```tsx
// В ChatTopicActions.tsx
<button
  onClick={() => openCreateSourcingModal(topicId, chatId)}
  className={`h-8 px-3 rounded-lg flex items-center gap-2 text-sm font-medium ${theme.button.ghost}`}
>
  <Search className="w-4 h-4" />
  Создать заявку на поиск
</button>
```

### 8.2 Предзаполнение формы

При создании заявки из Chat можно предзаполнять поля на основе:
- Названия темы (topic title)
- Последних сообщений в теме
- Компании клиента (из chat metadata)

```typescript
interface CreateFromChatContext {
  chat_id: string;
  topic_id: number;
  topic_title?: string;
  company_id: string;
  company_name: string;
  suggested_product_name?: string; // Извлечено из сообщений
}
```

### 8.3 Навигация между модулями

**Из Chat в Закупки:**
- Клик по заявке в списке связанных заявок темы
- После создания заявки — автоматический переход

**Из Закупки в Chat:**
- Кнопка "В чат клиента" — открывает Chat с нужной темой
- Кнопка "В чат партнёра" — открывает Chat с темой партнёра

```typescript
// Навигация
const navigateToClientChat = (request: SourcingRequest) => {
  navigate(`/platform/chat?chatId=${request.client_chat_id}&topicId=${request.client_topic_id}`);
};

const navigateToPartnerChat = (request: SourcingRequest) => {
  if (request.partner_chat_id && request.partner_topic_id) {
    navigate(`/platform/chat?chatId=${request.partner_chat_id}&topicId=${request.partner_topic_id}`);
  }
};
```

### 8.4 Backend команды (для документации)

```python
# Создание заявки
CreateSourcingRequestCommand(
    client_chat_id: UUID,
    client_topic_id: int,
    product_name: str,
    product_description: str,
    specifications: Dict[str, str],
    target_quantity: str,
    target_price_range: PriceRange,
    assigned_manager_id: UUID,
    deadline: Optional[datetime] = None,
    urgency: str = 'medium',
)

# Назначение партнёра (создаёт тему у партнёра)
AssignPartnerCommand(
    sourcing_request_id: UUID,
    partner_id: UUID,
)

# Управление relay
ActivateRelayCommand(sourcing_request_id: UUID)
DeactivateRelayCommand(sourcing_request_id: UUID)

# Смена статуса
ChangeSourcingStatusCommand(
    sourcing_request_id: UUID,
    new_status: SourcingStatus,
    reason: Optional[str] = None,
)

# Добавление поставщика
AddSupplierCommand(
    sourcing_request_id: UUID,
    supplier_data: SupplierData,
)

# Выбор поставщика
SelectSupplierCommand(
    sourcing_request_id: UUID,
    supplier_id: UUID,
    final_price: Decimal,
    final_quantity: str,
)

# Завершение заявки
CompleteSourcingRequestCommand(
    sourcing_request_id: UUID,
)

# Отмена заявки
CancelSourcingRequestCommand(
    sourcing_request_id: UUID,
    reason: str,
)
```

### 8.5 События (для документации)

```python
# События модуля
SourcingRequestCreated(
    request_id: UUID,
    request_number: str,
    client_chat_id: UUID,
    client_topic_id: int,
    product_name: str,
    created_by_id: UUID,
)

PartnerAssigned(
    request_id: UUID,
    partner_id: UUID,
    partner_topic_id: int,
)

RelayActivated(
    request_id: UUID,
    client_topic_id: int,
    partner_topic_id: int,
)

RelayDeactivated(
    request_id: UUID,
    reason: str,  # 'completed', 'cancelled', 'manual'
)

MessageRelayed(
    request_id: UUID,
    direction: str,  # 'client_to_partner' | 'partner_to_client'
    original_message_id: int,
    relayed_message_id: int,
)

SourcingStatusChanged(
    request_id: UUID,
    old_status: str,
    new_status: str,
    changed_by_id: UUID,
)

SupplierAdded(
    request_id: UUID,
    supplier_id: UUID,
    supplier_name: str,
)

SupplierSelected(
    request_id: UUID,
    supplier_id: UUID,
    final_price: Decimal,
)

SourcingRequestCompleted(
    request_id: UUID,
    completion_time_days: int,
    final_price: Decimal,
)

SourcingRequestCancelled(
    request_id: UUID,
    reason: str,
)
```

---

## 9. Структура файлов

### 9.1 Frontend компоненты

```
frontend/src/components/platform/sections/procurement/
├── ProcurementContent.tsx           # Основной компонент секции
├── components/
│   ├── ProcurementHeader.tsx        # Заголовок с действиями
│   ├── ProcurementDashboard.tsx     # Метрики и сводка
│   ├── ProcurementFilters.tsx       # Фильтры и поиск
│   ├── ProcurementKanban.tsx        # Kanban-доска
│   ├── ProcurementTable.tsx         # Табличный вид
│   ├── ProcurementCard.tsx          # Детальная карточка заявки
│   ├── RequestForm.tsx              # Форма создания/редактирования
│   ├── MessageThread.tsx            # Объединённая переписка
│   ├── SupplierList.tsx             # Список поставщиков
│   ├── StatusBadge.tsx              # Бейдж статуса
│   ├── StatusDropdown.tsx           # Выбор статуса
│   ├── ViewToggle.tsx               # Переключатель Kanban/Table
│   ├── KanbanColumn.tsx             # Колонка Kanban
│   └── KanbanCard.tsx               # Карточка в Kanban
├── types/
│   └── procurement.ts               # TypeScript типы
├── data/
│   └── mockData.ts                  # Мок-данные
├── hooks/
│   ├── useProcurement.ts            # Основная логика
│   ├── useProcurementFilters.ts     # Фильтрация
│   └── useProcurementStats.ts       # Статистика
└── utils/
    ├── statusConfig.ts              # Конфигурация статусов
    └── formatters.ts                # Форматирование дат, цен
```

### 9.2 Расширение Chat модуля

```
frontend/src/components/chat/
├── components/
│   └── CreateSourcingButton.tsx     # Кнопка "Создать заявку"
└── hooks/
    └── useSourcingIntegration.ts    # Интеграция с Закупками
```

### 9.3 Регистрация секции

```typescript
// frontend/src/config/SectionConfig.ts

// Добавить в импорты
const ProcurementContent = lazy(() => import('@/components/platform/sections/procurement/ProcurementContent'));

// Добавить в SectionId type
export type SectionId =
  | 'dashboard'
  | 'settings'
  | 'chat'
  | 'personal-chats'
  | 'kanban'
  | 'contacts'
  | 'companies'
  | 'moderation'
  | 'chat-settings'
  | 'telegram'
  | 'procurement';  // <-- NEW

// Добавить в platformSections array
{
  id: 'procurement',
  label: 'Закупки',
  icon: Package,  // или ShoppingBag
  component: ProcurementContent,
  group: 'main',
  description: 'Управление заявками на поиск товаров',
  // isDeveloperOnly: false - доступно всем менеджерам
},
```

---

## Приложение A: Цветовая схема статусов

| Статус | Text Color | Background | Border |
|--------|------------|------------|--------|
| NEW | `text-gray-400` | `bg-gray-500/10` | `border-gray-500/20` |
| SOURCING | `text-yellow-500` | `bg-yellow-500/10` | `border-yellow-500/20` |
| CLARIFYING | `text-purple-500` | `bg-purple-500/10` | `border-purple-500/20` |
| QUOTING | `text-blue-500` | `bg-blue-500/10` | `border-blue-500/20` |
| SAMPLING | `text-cyan-500` | `bg-cyan-500/10` | `border-cyan-500/20` |
| APPROVED | `text-green-500` | `bg-green-500/10` | `border-green-500/20` |
| COMPLETED | `text-accent-green` | `bg-accent-green/10` | `border-accent-green/20` |
| CANCELLED | `text-accent-red` | `bg-accent-red/10` | `border-accent-red/20` |

---

## Приложение B: Иконки (Lucide)

| Элемент | Иконка |
|---------|--------|
| Модуль Закупки | `Package` или `ShoppingBag` |
| Заявка | `FileSearch` |
| Клиент | `Building2` |
| Партнёр | `User` |
| Дедлайн | `Clock` |
| Relay активен | `Zap` + зелёная точка |
| Kanban view | `LayoutGrid` |
| Table view | `List` |
| Создать | `Plus` |
| Фильтры | `SlidersHorizontal` |
| Поиск | `Search` |
| Чат | `MessageSquare` |
| Статус | `CircleDot` |

---

## Приложение C: Ограничения первого этапа

На первом этапе создаём **только UI с мок-данными**:

✅ **Включено:**
- Документ BUYERS.md с полным ТЗ
- Frontend компоненты с моками
- Интеграция в SectionConfig
- Все экраны (Dashboard, List, Card, Form)
- Все UI-компоненты по DESIGN_SYSTEM

❌ **Отложено на следующий этап:**
- Backend API
- Message Relay Service
- Реальная интеграция с Telegram
- Создание тем в группах партнёров
- Реальная отправка/получение сообщений

---

**Конец документа**
